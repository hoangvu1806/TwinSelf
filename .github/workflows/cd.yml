name: CD - Deploy to Production

on:
    workflow_run:
        workflows: ["CI Pipeline"]
        types:
            - completed
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: self-hosted
        timeout-minutes: 15
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Deploy to production
              run: |
                  Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
                  D:\HOANGVU\VPS\TwinSelf\deploy.ps1

            - name: Start Portfolio Server
              run: |
                  Set-Location D:\HOANGVU\VPS\TwinSelf
                  Write-Host "Starting Portfolio Server using Scheduled Task..." -ForegroundColor Yellow
                  
                  # Remove old task if exists
                  Unregister-ScheduledTask -TaskName "PortfolioServer" -Confirm:$false -ErrorAction SilentlyContinue
                  
                  # Create action to run uvicorn
                  $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoProfile -ExecutionPolicy Bypass -Command `"Set-Location D:\HOANGVU\VPS\TwinSelf; uvicorn portfolio_server:app --host 0.0.0.0 --port 8080 --workers 1`""
                  
                  # Create trigger (run once, immediately)
                  $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date)
                  
                  # Create settings (allow task to run indefinitely)
                  $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit 0
                  
                  # Register task
                  Register-ScheduledTask -TaskName "PortfolioServer" -Action $action -Trigger $trigger -Settings $settings -User $env:USERNAME -RunLevel Highest -Force
                  
                  # Start task
                  Start-ScheduledTask -TaskName "PortfolioServer"
                  
                  Write-Host "Server started as Scheduled Task" -ForegroundColor Green
                  Start-Sleep -Seconds 30

            - name: Health Check
              run: |
                  Write-Host "Running health checks..." -ForegroundColor Yellow
                  Start-Sleep -Seconds 30

                  $maxRetries = 7
                  $retryDelay = 10
                  $success = $false

                  for ($i = 1; $i -le $maxRetries; $i++) {
                      Write-Host "Attempt $i/$maxRetries..." -ForegroundColor Yellow
                      try {
                          $response = Invoke-WebRequest -Uri "http://localhost:8080/chatbot/api/health" -TimeoutSec 5 -ErrorAction Stop
                          if ($response.StatusCode -eq 200) {
                              Write-Host "Server is healthy!" -ForegroundColor Green
                              $success = $true
                              break
                          }
                      } catch {
                          Write-Host "Health check failed: $_" -ForegroundColor Yellow
                          if ($i -lt $maxRetries) {
                              Start-Sleep -Seconds $retryDelay
                          }
                      }
                  }

                  if (-not $success) {
                      Write-Host "Health check timeout!" -ForegroundColor Red
                      exit 1
                  }
